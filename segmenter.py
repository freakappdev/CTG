import gzip
import io
import numpy as np
import matplotlib.pyplot as plt

# HEX string -> clean int16 array (0 and 255 masked)
def decode_hex_to_clean_int16(hex_data):
    cleaned = hex_data.replace("\n", "").replace(" ", "").strip()
    compressed_bytes = bytes.fromhex(cleaned)
    with gzip.GzipFile(fileobj=io.BytesIO(compressed_bytes)) as f:
        decompressed = f.read()
    int_array = np.frombuffer(decompressed, dtype=np.int16)
    mask = (int_array != 0) & (int_array != 255)
    return np.where(mask, int_array, np.nan)

#  Split data into segments based on long NaN intervals (patient separation)
def find_segments_by_gap(data, min_gap_length=200):
    isnan = np.isnan(data)
    segments = []
    start = 0
    i = 0
    while i < len(data):
        if isnan[i]:
            gap_start = i
            while i < len(data) and isnan[i]:
                i += 1
            gap_length = i - gap_start
            if gap_length >= min_gap_length:
                segments.append((start, gap_start))
                start = i
        else:
            i += 1
    if start < len(data):
        segments.append((start, len(data)))
    return segments

hex_fhr = "1f8b0800000000000400e55c79af24d755bf9f0914842584107f21249000092488d84262054598280427e399b7f5bed5d6d55dfdbadf3a6f167bec193c33f1c4760c4142e213f039f80ae6de737ebf736ebf195b4408f2073aeaeeeaaa5b7739f7ece7547d19be04fc961d11be193f5d043f732f1c45b8178e057a61103f3f12388870140ee5fa5138097d5c4fbf77c39df06e6cf343b4bd13e16eec25b5eec5eb27d2e79df063399f7a3a8c702f1eebbfbb72e608fd1fc75e07611c26f193ee3c882ddf43eb3bd2abceae2fb33b92160772b62733d23b0758413f0ce3e7241e9d081cd9f8470627d28ff6aa574e64d627727f02ed7918611afb9ec611a611e6116672a4308be7138c220c053743593fe79b7a190b4ca54dc2c13d595182b44ece4caf1cc8ac14cba9af91c0182be77a07f15cfa772498bc873b0fb1a21eee1d642be9cb3d1399f142608eb5cc651d63997f4f407b39b2bd3f141cdd15fcf4e5d3077e8953bd328abf77c23f84ef871f44ba7837eefd7b11eec6cf01dab06d4f667f80f5df93a36319e708df1cff10ab19603dbafaa16026cd7b11ca0845fc1d62bf9d5a7a3657c5460f583e00451c64d81e01d24ece043323c35fdfb03e11bc1f610cf2420ff31b022fce2f7dcc7620d786c0b1e2f5006d86b8f338bbeb187498d63390df7c3f8e8d5f74d7128c017db99afad61d1fdaf5f4ad3b3e967f89aa6642d7ba4ea5b3bb71df74ef7e0cc9d0c3ea27186d2c54348fdf33c1d442b05f863a4213dab00aebb08cc7a5d0da2c5ead2214c29fba6f13ec9cf2ec09e8f81e2404b9f2c4c69a80d3163256137b4f50c6ab3de39484a943f010a5d861a4bcb492b4cfe4ea01f642c7a54c19e0ee4370d10940f7752cab9cc7b10b596529e3a7a3221e2fe4bb1098c97725d76ac189b66c234ed661134ee3b7b6a5f498c5110e84530e44da1dcaa84ac9c7d8c3a9e17e20ebe84156f5413dba7394322a0bd30e53121c83b794a21256ee089e4fc0698790dbe4961e76a167bc37106e48634db0fb0bac3dc1143b530a966690928a8f89cc662654a7f72d4085cab50b69a1343a901187c0f954fa4c2b510939907d98da6a2718b72f57550ade1178cf74d13dc874a5e3bef1e248ee1f1a7f2b059c60e795df0f05677df0fb5d48326aafbb3206e5e491b4ec4b9f27f1fa7b7147ff5134d8a169414af87b903ccafb69252ac3125d6fe26721b84823f4807172772774a31cacb4bb0b1711ce22cf35f1da089aa797c98331e41a67a9ba2a515e25a35602d432aac7a6e06c8529387021fbb990d16742674348a931fe0d40b33dc8db9cdf2742bf23c8c1beece64c40af4ec0e513d1971393be2af50799349ec6f5a6356f23b6da88af16dfb5e0b08ced8e64f7934649ba7b08dd4c4e99404e0e209127e0c5b9e06329fc5b40aba4e3c56b36d44d84fbe132f2b24ab091cc7e01ae4ff81c0badce653d8ac58158274a874a817db33e7a90746a570cc06163d1442370d308a3703f12f4819ba1ad86ba2251f118eb1a1b762732ee3c4aa1b3701ebf379049a71197e702bb08e9772d14d5093dd6f15f27928bedae22feafe2fa77f17cc2fd1ad2ad15c9df44984252512ef54d76e4da6a84198e64561368234afba950da02b225617685596ce23c7662c52e45ce54d2a292165d6cd19a857b17f31800bf33c1e25cfa5bca7cbbd8d736e223d1d4795c93aeeb0c1848da4c57a490f825dd3d915d1fc35e181b7655cb26e9a12b2f40e163d805876605f520f1fab0ec945b26b01329a5466835145e4b6d5dff8fa4ed5038a307b9d5379ad6f17ab0c5f5fcccac9c01286e8c99d1eaed99f6ebc32ae909ddf64095d443ec678c15f4205f0622cb125e77c2a15dc4f342f09820eddc1cb64225f2ae11fa4abb97ce8f31622fd344c7b0cdc6c2313d933003590f297c2aeb3981de1f40fa8ce4bb8f9572359ceb9169ff7c0507d9b523c3ea89f90ce4da23f80d3dc3fa10fa776036dfc06c38dae503d0c510d6eab1d1c4d0ee72addbcf6c40b5508eb1baa9494e95c403d88f27a0a61e7aa725d5c3d813a12ea5db21f41edb28767be635f93a7b6649ba85aca3abc44c7bb98dbbbb8bdf6be1c053f9b7132a48bca412f10418579d378324536db2903d4c705bdafe7f816fe0f7d8cebc25df13f9fe8dafb8ebd76ffdff23fc26cfff5c8e3eb56b97a237afa2eebaff3f9eedd3f03cfc5378113e8e472fe3b79efd663c7a163f1f870f22bc1f1ec7cffb6fb8fb8ff7fefd79fc3cffca917e05bf8ff17b73ebfaa3f030422794b71169be15bdd441b36d229c89de3a93cf85487afdb7c3d16584f7632f8f04d2bc3f8cf37f22ab7810ae0567aaf5afa457ed398d97463917caef40f31b1943b1fc50667426f77e18b1f222fc24c2cbf02a7c12e1a7f128fd7f158f3e8918781aafbf942b9fc4a317f1ccf3f0513cfb28cee2a308cfe59e042fe2d90f459ea6395c0b0e9ec4fe5f869fc5fdfe347c16e15f23fcfc356c7e2ea3a716e9f3f308ff16fe3dc25761ffd9d7d0c09f45f832fce6adfe3f93fd7f2e9fe732561ae98b089fc7cf3f5bcbdf8fc0e384996772c7e732f7cfe27d8474fdd7d0ee2de1899ca212265f46dc3c89f8782c94f058f62fedde9378f42c9e4f9ff4fd32cee4456cff71c4f967118baf847e3f06ce5fc9b83fc30c3e89bfafe4dca771ceff62f0263c5ccbf76f7f05967ef50d6d9ddbdf0c2fbef6ea6d5019700e7ebf0ddf8ea047ef84ef45f8dbf0ddf01d39fbedf076f81bf04107ceb812b80f0bef325ebb168befbe48f2c42fca4f1bb1b356e2df36f17725fcd70917e8b5b5d850ab78e43cfcdf87df7bed8c63ec347e7e3782fe7b3b7e3672b494efaf1beb4d5254dbab2592ecf4b9786053b17bd7f0f397005d532db6a6da9f0d621da5c5251ab46bed7f2391117a2a8495c0129f156cecb58c56495b62b48376557eef44bad1f35989e54d0b7c23e72aeb7f2dad1acc7d259f8dc82e4a469de70af66d2bab598aa5bbc47d2dceeb5eb6d256fb576c74f021d2dc5638dfc1b3d8ca28a790943ac34efe7738b79219ad6c266be0aeb599b7069ddcafa3a5fb1bf1b56acc7c056f44f7823627ad77fed6d27285ab2bdb05ae565bea3e7532675de5d25a2b4e9636b7da66b184a7441cb6e65fed84cb2ee4d3a147dfc195ec78ba3bad68863849096fb244ccab9278c94c7c9712be6e65b127a5528d4955b8ab828fa3a355d25b9b61a2166cd4725c216ac5d8556db8a811bfab8523146f1be38dc6a8a2c4988dd19eee64010faeb0311a50bdaea0014d3572bfaebe905197d2b7ce95f826de3ab135d30c6847ce800bdd13c6e1c8753a6eb117b9aaacc702a0e74bdcb9c4dc5a994589f536f075db0c4ba4d552a096bd4c2d666261a71555165d282c2e987a2ed1cb2aebbd95f31a2b4e9122fa95c937d6d8e3c6ac90a578a363f1a0d5afe2fe3758456d33dcc07356397e8d288672e9b94404b66641edc42e3a03a771df97e849f76705baa794ac81657a77e4a2d55e0f2da8ba342a54ccb49082b9546af15961c52b48324a4f8502519105645f05da7709d941362935ad709cf66b65bc35431ca2ccbc9aa5e0b2c96656221e33079ec92f8af30af245db9e0387497f26cebf8ed8be8e38bf460466237b7119f7e152ae5ca075d2c3976251aafc548949bdaaf85ec3b254dd7d0af9bab22b3bf47321f7921bd7e05b52a972f22924ea296841c7bd10da68a189d6904e04ed51f5480bbdaff6af5a11e973233496e061b4a293969d8a55a6a0dab7142d5a4ab4698b3e6ea23d7b037bfb7eb4e59e44fb4ebd8a67d1727b2156f273b13093ddf82afa21099ec5768fe3b8c4e98dd8801f8ae5fc026d5e087c12adba9fc0c6fea9d87aafc4f2fbc22ccf641bbe8ced3f882bd8c91eec60d55f087e3a397b293bbc912887db3ba7828373683ee2d43de24bb3b22e25d6b4450b72ddb9ecfd468e3bc8c5a5d90a2bb4a9452bd4d849d586ba536e8b6d45b33622d5aa4ceaaf2045951696b03d4e452eece053ec2416762554701371f181f845efc3ae7e1a719afcbb27c07182a7119e093c97ffc9fa4e7ec9b5f84fba9f57b2a7ca03e7f0ca34eaf640e01a67ee671e573abe168b54b17a8e6bf7656e67a09b7435f95b1742018acb9decc085f056eafdb1f805691537b2b633f3e33a786f5bc842e708ed5df9ec14b2493d4db537d6b02e56c2473bf05a87b63a8b2da4ee95ace44656f3207e14a38fc46fd115ddc4f30f31bb6b59cb36e3fa53b11053afb4759a4c4e6e30e2a9495c6a60463af57ee6ae96590b5a8f6bc861d56f5b502eb539eda446b87587b56d845a76821fa5f24ba1e0ad6868ed5523b72b60f24264468273890d2da1af0acb1fba15d89af5bd8226da6492a203bd7798e30a2bdf408f9d22e7760a9b77855e1b60a101f6686952ebd3365149b7423f6e396fcdfba77de856446dd2a085d5559a2d57990e5c9a75de5a0eb5104de33dd2d25dc3ee5fc386ef6c3d8a8573c1b8f2d803e3d30ff0ad5a7e2bfb732ed26727d4db8a3c2f918599993e6ea0d575be6e3f30ab9bec9739eca4dab47a297141cd5c4c050b8933341fb810ad4afdc83ea83d1bc8215d974ad934cffbf035d5da4bf49524c999e0be15795661cfd7a29535e752a2f7522ce9197684679666116fcc97dac2f3bd36fc3d125c5e22d6b38134dd897edec196513a294c37ae61c52b0dccb13ea52e95185b58052a57b6c23bf4e936e08f0ebed3cafc23f7c7cad09a7fb5365a5c43f253e6ac6c176beca8fb9a94052d6c9c0ad7f7adff16fadced05fa4a9d689f33509c5a33ba2767585b27c79722f14f454eb5b286a58d5f637e65a0675c1b5da4756fc532a5f4bf9198dc07623fa8f6782012f29148cc6bd1076782c956b854b9611bfb4ef1e942b235ea4b3590dace49e441fa755da6bd2f9057a586d8821252fb5a321635b24d1bf8e6b47c54b65f20fbd1c16addb70869d5f9f95546456bd0c01a5e6c037e2bcd77f59d5c67f2929456992fe3f188d62851652d736a4bec7e61f44a4f66058a2605515ed6b086a91d579022b9055cc1c7a984070bec01a58c4a1c951f9e6b656580ce8e2dd4a39b5bfd0577d3e528f34a1babc098cbca3bec73077933874fa03298386e6535353cc11adc46dc324af08bc6aefe77616a79fa11ea25c692e91aefe59a07a83bf3ec14215d51293db6bca1fa970babe850ef98fda5f369e43f0c7f103f0a6f9edb9fc4cf7fc6cfc27c24a5c4192a0006e14ef861f841f87e7827fc9d7d4aa95d589857b2043dd2232f70a582969c5b0d8d8eb184e44a54a45e7e0d2da5be997a767dcbfe0f654d4ab589be27520da17cedf9b48419e6af356f36410d8bd2f102745bc09b2d714ef94a5792eca88571d75a7899719a3ab06a688e98472954af519e397888dc5721cfad5ace756a05dc348621e592096afbdc4f6dc0b19bcc02a475a271a10a38291081698487dcabafc185bebbbeea99514d038dde023fac94d47bbce6c4694b75f6d4ea88b49f02b11c8dabb516d1ab33cdb5829da211940ab3ac606da834a26d559a0c9b8bdf5f9954d3f8d648f880368dceb01639d898b5536275b5c5082963293d196558ca9ac658e14c56a416096972065a9bc0fe2b501735931a97995536f2bbc2feb3de7462f95fd66325ba3996bc382bec4af00b33e543c9d932833b077f951915ceb1dbeeebcf250e3542defd18954013e1aa3172c9135422b036acc46c585534360a684cc2cfb18e05563d850d474b6e6296298f0a8b2216d8db0672608cfa8ec2a893b2413d8b3ab37354ffb83c9c18e5b1de89950dba3af2ff14955173e8aab1fd9b0aedf4919f1f8a5cd6ba50b699a1ae6a0aac1758332b2817a1b40ac7b9d4fe9481d594ea09ac45a79d9a97ba43bdce9965324fc5bed0bccd851d5dc28eba463ce68164c81e8a2ffc185199a71223792619c4a7f0dd9f886fff48fad29ece24eba371087a340da4590bcb8e59d753d4126db2387f039f937e1a730df45f79c62d8e3524a672bbd2975a0c63a98852393db19d57df85be5d6df1bb2a30824dcb869e57633c4b3bbbcac6d7d84b6bb24ac76883e7857289abba80b6c569f0988feed48578f41a19bb366f237d5f98a7bf315f4e632f171227b8119bf21132dd37b0204f45c2bad59338a6326b2ce17261fa7f80ea2a6d35853d45095019af78bcdb758467054ac855afff2c02e3d74be88785491ced917a865aa8c41ce963ba165c98b798571fbac557c1265864126386a3b99de71d0b500a7be655d7596e958ead2e670218a3edcc743367e1766e29f298764005c9b30873d44b6a7db5db4094e03aef894915af049e033baef5d5c79cc16e538a1f981dc7eadf21ea09fb56e7a3f55d33ecf50c728cb5bb6e9d5719461790ca73db43e2f3976df1fedfc33bbf40db5c8e544163d99e45e3d112d66003eda59a2bddffa75247f11711fe32fc55f856f86b816f85efc4ff6f87ef0a7c2fcee8efe3e71dc406188ff1785c091b6f09abc8e3c59eed6ccdb2c9ef5c66d4e6d5b4adf9fd6bc427b4966b8b88f5da247b9779896dd08c626d3db776a5cd647f87f89367239b6c06cb6c7e9a816cb15efaf05b443b3bcb15d11e63b68f9ccacc6f95716113987765a48d328ff19065601cac0acc2eab8c2b8cff9923f4ccb147536833e7fe337373cc1a7a6e92d29351378eca15e4faa8c16a1af33a2ad3c5796dc1fe8c968199dc067bc3a8408eed1af6fa0c1e16b3786eeb3abde4f3aec23e25b57ba3e714b0ccf0ccf97a74a9b3784817989b682d52594002a7997566679c22c2e235021a3fdb58849a798695456f346ed7c09a59cbb81b44d0d7d9dcdac0fce3323468b7368f8852bfc8f4fe1a7ce3b36f11e7715c2be57177b9db15a89cd19c6ecf4eba0d8e3de572cfced619e45867ceb5ca2885310eaf7f60748e96bffb63ec712816ee041acb7d87c27c94628f6a5d8690cf5666a73975922a189ba2add5987d505abfe4f5d6f68735144b1b639951948e438b40fd7372612ea958dde19a51397d1918ab6ff6a4cb329b85e2d0f30bb924a3d75ae34ef58a4ba320c65e4be3677a83b9ffacbea13f69541a7e6a6873ca0fc67fcbe096d51c165b9d8d4719b32f3bd58eef2c12e9517fd6246d24efb943fcfa0c198a3c5ea9f168a546e580d674136b9dd6c285535824b415d5325c056629f3fcca3254b65b35b42e6b27bc968719a7b5ed67aedb5cfae57e46ce39cce13b2db521d7106da6af2819f771dfd808ac1f69a0735837c488436e15d39a9da2d2fb004f8a8cc065b95ef0ca79dd47fac7b4d8dcab9cc3632eb23b5be08ed1f72ab072a70c75d6bfe3da69aa319de7926c6dbbb441ccfb0c55df94ce6d9ce17b78e26c08ab98f5668e57aff5f0dc43070dbfb1caaf2ed04b74bb85fc4739c2fdaa02734d0b931c4b93b7b410aabd1552f73bf754765c6640bb99b54d8cde2cc21c4f641c841f8577c35d54efcfeca916461b3c6f5fca1ef6e5d9d57b786a833bca58e7c266a0fa8b1e488178069fe5657c8e4f669621b7c53cde55896c21b54ce127141935f0b80a7c12aa0ad52dbce5be1c2d1ad5b2fa24531fcfc58d2d1ec54c686e1dbb9596fb3daee748fb6e39d53607ea09e5aac230a3fb324344b5c8e6cd719dca7379bfcf95fe4d1d9d7b80d4476af3529a7396ce5f7e772e237c366ce5d27d9eadc4f50eebd85c4b96581d63e445e6913a86a8f7892dc77deecb3296ec1177aec5edeb36dc967273a999dab710193fdcc75f6ddfc47fb5370f9f490d1faa098cf7f31963cfae123bb9b66624d9a32284a949443f3f479cb942fc70644f3733dbe4cfb74e331edbe732c6ace90f34227798e39a073e99e69176ca0f973b9c7b4e75857d1776c7be85404cb1d6d3e3dc1e395e8412710cc6df1776afcbb222e4582b338c176191e19d409a2badcf3962071e639abf061e1bf2674a1955f338b7c76afc37b5a074c8f3d1b9c4a0f4ae8deabca6b30cfb34e27cc17cc7be2fc2ea0d6a20e60a297bf251dd7256ae9cdb8c49134dc667c46a95edf5be5ef1392f0c532ec5c839ac85a59fb1ccec1d5a98cc02781ecee539c7f27a854570fee039ea2c52bd671ba6c1df1c31b51d769de5b135e62aa69811af4ff11c229f9c1b496e82ad98311867bcc7e8da3ca30aa79d5c6a531bbb4e9cdab17b34fbb1c2c5adde482bfbbb93d316b960bf1694be31ed61d58ab9855fdc02cabd7dbd52fdd263605f07ff81df6f00bebef5175f79e52dfcfeceded94d607db6029f112d8c7e1336f35ca2da6cea9b2fc4eaf03731a894a43fbc126b8436f5446ced41a00d91a4b7d6fb6c516dec756f8c6cb1eac39f7bf02a4f5687f1c9477e9fa392a4cb6c5cd6706d51a7b9362b9a75201b44d8dcf2656582c746d416d49a337f46827633235d5e33b64586e112cf797726e7567bb52ebea6f59e4c743f4ba3780bf05e879eaaa03913b5074e25dbbc0aac462557d4c8e87a74c86d298f3c35a29b59c7428da7be147d42c583c6d9f50d230bc1359fb8d00ad64bc9b95c591eeb14f8e4331b1b58e2acd5cbed097f9b479571add7cbe4910e7a051e0b99efb56604c4334d1ecbd0d5f0dd1d9ad54ab607df7933c0bb005807d4c1ffd60ada73acf352ea63afa50ee9466ab4b4425c5794de1ba16fa638cc3267ccd64e2dc2a6f9f02379dbc591f0c85dbcf3e648fc99119e3e9fc1e75179adb2d0af4e65fd63fb37b05cb7564894269f2ba3628f4ef93353accff2679f3c92a56d3a701f9fb6f1678ef2e7f797814f2b698d2a2b83533ef4fdac3a586b9c3f923ca8d6a23d88dfbbd05a9c82fcabb10fc65b952ffcb91f56a0ae21815a4832cfb5b541b3bdfa7e0d7a09f4d11a703b23dd4bd39c9adf4994b60cac0624c732faeacf4f79d482b1ac5cd630da9ac7046ac436ea4cbb31de90fbdc5e09a9b956d7a555601d86db5adcb13ca2ee1105d5b58c0928a7300ab50a8c60f25d2915248d9e1de1bd0e73931d1ed799d95b16bc2a42234f7c2f06df4c5362deacc0f1cc2367ee5979561893ffae50d5cfdced953ce9459c294ec6788f407a2bd60899475a446ee52be6e6b83242c4c42d7e7a95f4cd5c1a6f2426c7aafa0bf0be6a1ddf39dda71276c9021941955b7944375f7f2ef3aac03a3cd6b992b73c5ade068f4eb9ef97d637cd34bbd6127690648cd3b3f27283dd9b48d6dfbd5cfa59ca0b5ec9b812ede3d1e219a882194f7fa70b7b637ca516ed32b237fe0c4111e4c71a5edd0ab59e67d8e7eb3dd0bcfea564f61fdad3ea27786f44cf6a81fc2d511a69f4ea61d5324348fb63795bcf2c6825b3478ddc7ba08f44afd6e9c82b1318fff3a70137a82121955ca13ee406fae2124f6ce893175742457c326483e8aad6ac329ecb38bbae6d62fe063d8b9c72f42d28efc9fbaef41d40b946a5f4df8fcab8d7c3e882e73b3c6ec7da38c67b48bdee1fd05ef72cb7c786f2d9f23d291a574df78cc08decc39ff7ad83c6fbf83e14d612e46d961927301647bba20a955162ee15948603f7348ac02a584aac3c4bef1632697b16e897bb67e71ea0e33c8f3d55d95c194fbaed45dff663aa5b405f696eb3787d06b92fce19ccb3397b5dd4eddefded4c79f4218fa5795cb108fbfe16b3e4be177c929779799d1571e9b8704aa1866446d7f1eeb2a7408507df0d441deaadf38a1ad758b7a99e349ae329cfd83003c2185d636bf7dc582ec1739fc8b3d8f56b63e73acfb96e3f0bedd9608fe011bb6a49e76bf528c8c2ceec8fa57715763d3faf7acadf36e83b492e64242597355ef9ca08714e21a4c09971b6fbfc0b9b873e193a06c7f1e9d0cab4589d61e9bf00bac699d178550000"
hex_ua  = "1f8b0800000000000400ed9c79531b3714c0d5b4900bf00506db181b03b6c1e62c9084a4a54dda34339da6339d263dfee8f7ff16ed7b4fd7d3b536b6c134597e63efae56ab95de21addeca3c128f1c1e3b3c114f233c71783c0316c503f1257cf4df1704ff5b141551020e445d14c4127c0a620dd2ca0115430d3e05b122961d563d2a77887fef79b03605f3ae7b4e4e9c2c7b9dc6e2ef12de9674cdefa7a46f52bbfbd19fdebe1e6feb8e0d36d661b9eb403a77f5069a49e7ccb6c9b404dc31f976e58e2dc5bb3481063c27d4c406a455493eebb417eeeb2d5e5387fc6e3e9edba663a9d89206dca1ea48a56a34c1f5a3cf59e2b59f2fb21628bf3523bd8d68fb637271db156be524b51947e7e93a6c18fc1a8fb6e5e925791f747a3bac8f60b47caa605d3565611b9e9ea46eaa639635bff6cf4272b75db7d9d8f4245e38abb2b3affe774e3cb9237046fe10787c6777ccc9c9c9b9ff4c378bcdc9c9c9c9c9c9c9c9c9c9c9c9c9c9c9c9c999844ffd8dc47d6749ac0055f19bf859ec88925886a37de04cf4806371212e810bf135f0425c8b233124f4aa145c63586414e058a6cbe30d51070e8097e20aca1b50e97da0477b5db14becc11eb2477b3d421eedd2b76517ca3a87da9c012750e2211cef43ee3e9dd3ec10bb51f622f07372db57759329babc9d808efac6ed81698f8bce852575126c47d167fdbb62bd508228d901e86340df439006227534a07308a61d198e416e926305a61e524eab9d1e7d77995e764c4b77d9f10e4be7ad6903ba156dd122f4517b446b3b8976bbe7764d9a5b826f05b1abf95ddb749f4e507e587227da52494bd1be012dc316d0124db1093409bdb765cadc5692ef926ef649e352b327e214bc017df482409f7d0e5c012fc9f3aee8183df91c729e82ce4fc9874e48f743f57d40bed4277d8f273b2d9bd02f2621d479da32d2f89e928debffbed7f2365bbde95ae93b74c917511bc7a48933a5896700cafe3be0b5f8817827de8b5fe0f301fadc0fc047f1277c3ec2de1fc45fc03fb0fd9b527f879cefc5af70d53bf19378033df03569f425e9f33969fa12747a0ef73d519e3c54fdc180f42975aae91b7aa697e5607aac7f746534ae26533a49e51a2fbfeb41e839b8b74f39501387d49216436b0cf33615764f1fa7d0fee95f11bb2acc11e66d8e5d5abc5cb766d3e3f7c7be1ea48ff41838ee686b97bdce33ea6d5e896f806bf13df046f123f016c0ed1bfaa017bca6cf6bca790dd760ff74aefaa343b25c3d0e75333c7497ce0ebdb37b6af43aa0da0da8a45e06b1e752b936b1261a200f6cafb43b2bf76d48c3a723e969a7c48064219f4ccea03517aa177e4b3efc2d79ed80ec14470b29dfcff1f9179f390bce532352322cd3d9d2bda140bf8359a1dfd0c8dfc4d468ac6ed29abc0e3de376c9def099aaa99e8953331eb96294afd79a748d7ad61a6fbdbde99ae0ec95647c2d9e5c8128d725d6c14f24597d58aa97dc8cd030d40db17ce175f5086e493553eb49a8dd087fc5e638dcb434a99be9efe44bccbfa7d47b8d4922abecf47ad7f0ec46b285295d6a46c97f5cad36024b0a47dcf4c8bee959ea38f6c2b5c073dfc426e23291704fb2f9787d435f6b381249b729d6c2063bd2beaadb53f3daa62d29cbaab37e51b0ee48c49592d6e5b8b577fb03bcd6ea7acbc8ca276693a3742ecfb952d75ad136d7a2a70c6b7f2dfa6d86cd996ed5a6baceb7697bc526e569a9b1abc9dae95b015e29e7eb5baa545d3ffbcca99fbbf5937593d6a2c7c7007d4d43edb7d98c8a3f896ea9dfa2a4acd91f339a4efd633af1c7859a6329d6ef1b81deb85f857aad3389f019826e2b1fd5d2a35e6c1c94f31a1b43c13d9c8df39cdb2cd2d061b358f964199bbbb852d631051dcfd8a3b8951fb51977ee6da33a767e1c9bc3a563083b2646c4ebaee3321d636ba19ca595f27bc8198b1b9349cd7bfc7ab7d9b99054bc4a97328467fe239ab5a0460620d56dd1cebc7f764ca825f86c75f634551decfd78b440ceb3a7bf4bacad59d2e898d8229fcff529e2a51998d897cb9189684a4e1c649a9cab9db0c8e751a42419451d18860e36b2e2b23f92be99d5727a2c3d6bb61b8fc0dc2436968e6fda68e874d89ecbf633b64f702369a3a212a3f2c4b80d4f8959f4ff1b1ed1d67ac7b6a52d23de13768ca77655d4655fbd95181a8f44df9331d1e7e205202397cf089972a5629a2fcddeab4cae8817aa342ce7d24346a42ee94d918dc99c29efd77dc009eb038e047f7772a0deac70df97fb47ac97e1570c4d149dc75ef78d3cb27b8cbe434fc9d2272b8a158be6763362b8a39945ff3269afd4523d498759de769032299f63d46d363c125f89c5c47fa5c1dfdee12ff016d97fa6792016e018c1edc3315800ecd3bddc5b73665e359a11caff6653142b54af35a17f6b5ea78f9e7fae43aea76299fe0b8fade9929a2fc908af7ec68ac7cbc2df5e56858d7fd9996a561c249cbfeb73f1d89a1b17f14bd36d2fabf663447289d0ffb36729f80f44beae564dec714dc51f317658849c52030b4a6f5a2b8b2675012c80e3c7cdb3629339b326fc7f4e778b5f9fd9ad0c9ab764e7cfbc753b7bebf854da95338ab8ce2b6af48c8f91127c96efc3f85ca6d56408ce016d1c16671d0d15837357ff60248ccfea653fc26b55a2ef55a756fc4d9fad79d80e599a3b66aeb2eb2cfefbcc22cbe3bf5b744b5f756a656b208fec37f7a155762473544cad742972bfe8a5f39a97826faecbb229d5bd53588350fb7e29fc5affed6ff82ed8a6161445b38da5eabd9297caf3fb6f9e8beaddae5b022f87d7ac6874ead6566b514bc7b57badddb24aad04520bad914b788d493496a36c4a0e6dccda75c9a95dc9e44dbf8bb725f06d8559530cdf42e2846db0b5e15a2b51bf511645474b054f67b88e557e17d4fa02a9d515b38de9b7c8eca1e4b4bd68eac235eeb6af14b4a2c4f21683725c09bbf65ff4ee9ed2852f41f7b8e2f82fb738eed9abd48b95237793125c3172e47bfcb840d27673733fd3deb6e2f89c9686f5297e6f6eb9bebcfe03770b68f278550000"
hex_afm = "1f8b0800000000000400ed595976c3200cccc17aff6bb51f7d7ec1a065b4017118ff34c61a8d367093d7ab0a3fe495c385dbcc4134be98cf4acf79dc3e9d92cdc8989f091fdfec5ec803a65b8f4faf36d5bb78a51120f381ac46bcdaf2a05d5e4d56ccdfcd24eca4a585ad6eb64a675eb991a24f236bb51a2dcc7284191518d96395a23bcb0f4f4755f45a14113d48fd74e68cba62761e0fab2a159d21ff7b585d77cecf645dae70efd67554a95df7efa2ebe01bf13e09da3bd4f980edccf254f09fb079a2a60bb5e694cbbee6ed4395c02a2265e7fb40e5497afab269ad572353013aa32813e2a3bdafa9d29eb4a99bf35e45ed50968cee349d7c74b1ddb3b7c178f43dddaec277c971d47acfc0c593cb38aa8ca8a6edfc35d3722957995ecdad0befdb667bd9a0ea32e7e6fe9495254f85b5fa322be293664474f05c484e22fc73a0673c93f37def9e4734df35595a95fb6af8fb7b5d3f5ab183cebc6ce555ac261b176f85af0c1654533c6bb995bafbf5aa7f1aee715151f2b1cb19f1d667a79cd33a9ed307b979ceaa566de5ff999ffc8b04ba07ee036d07f0e8c66c712f2b3228f9d37394b1034b6ced0a1e8fe53e164dbf9e032eafba0f4d07a6908a4cfa3ec807aaea767bcfbcd2f5b3eaf647efb3b4da7053e299cdf8e585ef1bb82cefeb70ef31fef718b98fb96c7c766ebe1d7cdd6aaaea65a5bbecc9efbfeb71e59ade296afce1bf365401e7f69e0cedb3734f9a71c7aefcefb4e7b779cdd427f1505ee813ae5fe314d3eb7a3cbeaac827b26d955260a917a2d2132df7ccdb7ae4894e54dd04e215f068e6e3c6f3a1f77136ee75c43af36e897ab1f28fb6a81f9bca58b722ccbc3794c3e375f441f779e4ff3a8a8d66b4e4189d26ff896aedc7ecce40b46096ed5ffde72c6d1e9bf84471b675958861ecd17e2d96078a61562ef84a7a7b772fd0fb589cebf332b13baafb6d75ddac3b3fb7ea3b47e6e27973f28e85deab6338dfbad542ee457ee7c93a2b2c5735f41d0661e0de58b477232dd636f3d9d7c10cf4f99e9f7d9fc7f5bd62f77f3dfb6933b08f92836aecd07779dddf33c933367feeeabced50c783838383f5f803af5e32e478550000"

# Decoding the data
fhr = decode_hex_to_clean_int16(hex_fhr)
ua = decode_hex_to_clean_int16(hex_ua)
afm = decode_hex_to_clean_int16(hex_afm)

# If there is a gap of at least 70 samples, count it as a new patient
segments = find_segments_by_gap(fhr, min_gap_length=70)

# Draw a separate chart for each patient.
for i, (start, end) in enumerate(segments):
    plt.figure(figsize=(12, 4))
    plt.plot(fhr[start:end], label="FHR")
    plt.plot(ua[start:end], label="UA")
    plt.plot(afm[start:end], label="AFM")
    plt.title(f"Patient {i+1} Data")
    plt.xlabel("Time")
    plt.ylabel("Value")
    plt.grid(True)
    plt.legend()
    plt.tight_layout()
    plt.show()

# Print the length of all NaN blocks
def print_nan_gap_lengths(data):
    isnan = np.isnan(data)
    i = 0
    gaps = []
    while i < len(data):
        if isnan[i]:
            start = i
            while i < len(data) and isnan[i]:
                i += 1
            gap_len = i - start
            gaps.append(gap_len)
        else:
            i += 1
    print("Length of all NaN blocks:", gaps)

print_nan_gap_lengths(fhr)